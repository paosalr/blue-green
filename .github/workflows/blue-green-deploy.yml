name: Blue-Green Deployment Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  validate:
    name: Validación
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Validar Dockerfile
        run: |
          docker build -f Dockerfile -t test-blue ./blue
          docker build -f Dockerfile -t test-green ./green

      - name: Validar nginx.conf
        run: |
          docker run --rm -v $(pwd)/nginx.conf:/etc/nginx/nginx.conf:ro nginx:alpine nginx -t

      - name: Validar scripts
        run: |
          chmod +x *.sh
          bash -n deploy.sh
          bash -n switch.sh
          bash -n status.sh
          bash -n stop.sh

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      matrix:
        environment: [blue, green]
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build ${{ matrix.environment }}
        run: |
          docker build -f Dockerfile -t blue-green-web:${{ matrix.environment }} ./${{ matrix.environment }}

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Deploy y Test
        run: |
          chmod +x deploy.sh switch.sh status.sh stop.sh
          ./deploy.sh
          sleep 30
          chmod +x status.sh
          ./status.sh

          echo "Ejecutando switch automático..."
          ./switch.sh
          sleep 5
          ./status.sh
          curl -f http://localhost || (docker logs bluegreen-nginx && exit 1)

          echo "Ejecutando switch automático de nuevo..."
          ./switch.sh
          sleep 5
          ./status.sh
          curl -f http://localhost || (docker logs bluegreen-nginx && exit 1)

          curl -f http://localhost:8081
          curl -f http://localhost:8082
          curl -f http://localhost

          ./stop.sh